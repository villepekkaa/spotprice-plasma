# AGENTS.md - Development Guidelines

## Project Overview

This is a KDE Plasma 6 widget for displaying Finnish electricity spot prices. It uses QML (Qt Meta Language) and JavaScript for the UI and logic.

## Localization (i18n)

The widget supports localization and follows KDE Plasma's system language setting. Currently supported languages:
- **English (en)** - Primary language (default)
- **Finnish (fi)** - Secondary language

### How Localization Works

1. Strings in QML files are marked with `i18n("text")` for translation
2. Translation files are stored in `translations/` as `.po` files
3. Compiled `.mo` files are installed to `contents/locale/<lang>/LC_MESSAGES/`
4. The widget automatically uses KDE Plasma's current language setting
5. Falls back to English if the system language is not supported

### Adding/Updating Translations

```bash
# Extract translatable strings from source code
./Messages.sh

# Update existing translation files with new strings
msgmerge -U translations/fi.po translations/spotprice.pot
msgmerge -U translations/en.po translations/spotprice.pot

# Edit translations (use any .po file editor)
# Then compile to .mo files
./compile_translations.sh

# Install the widget to test
make install
```

### Translation File Locations

```
translations/
├── fi.po           # Finnish translations
├── en.po           # English translations
└── spotprice.pot   # Template (generated by Messages.sh, not in repo)

contents/locale/
├── fi/LC_MESSAGES/spotprice.mo
└── en/LC_MESSAGES/spotprice.mo
```

### Adding a New Language

1. Copy `translations/en.po` to `translations/<lang>.po`
2. Update the language headers in the new .po file
3. Translate all strings
4. Run `./compile_translations.sh`
5. Test by installing the widget

## Technology Stack

- **QML**: Declarative UI language for Qt
- **JavaScript**: Logic and API handling
- **KDE Plasma Framework**: Widget APIs
- **Qt 6**: Base framework

## Project Structure

```
.
├── metadata.json              # Widget metadata (name, version, etc.)
├── contents/
│   ├── code/
│   │   └── priceFetcher.js    # API and caching logic
│   ├── config/
│   │   ├── config.qml         # Config dialog entry point
│   │   └── main.xml           # Configuration options
│   ├── locale/                # Compiled translation files
│   │   ├── fi/LC_MESSAGES/spotprice.mo
│   │   └── en/LC_MESSAGES/spotprice.mo
│   └── ui/
│       ├── main.qml           # Main widget entry point
│       ├── CompactView.qml    # Taskbar/compact view
│       ├── FullView.qml       # Desktop/full view
│       └── ConfigGeneral.qml  # Settings dialog
├── translations/              # Translation source files
│   ├── fi.po
│   ├── en.po
│   └── spotprice.pot
├── Messages.sh                # Script to extract translations
├── compile_translations.sh    # Script to compile .po to .mo
├── README.md
├── LICENSE
└── AGENTS.md (this file)
```

## Key Concepts

### QML Basics
- QML is declarative - you describe UI structure, not how to build it
- Uses JavaScript for logic
- Components are reusable building blocks
- Properties are reactive (changes auto-update UI)

### KDE Plasma Widget Structure
- `metadata.json`: Widget identity and metadata
- `contents/ui/main.qml`: Entry point, handles compact/full view switching
- `Plasmoid.compactRepresentation`: Taskbar view
- `Plasmoid.fullRepresentation`: Desktop view

### API Handling
- Use `XMLHttpRequest` for HTTP calls
- Cache to `~/.local/share/plasma/plasmoids/com.villepekkaa.spotprice/cache/`
- Limit API calls (max once per hour)
- Handle offline gracefully

## Development Commands

```bash
# Install locally for testing
cp -r . ~/.local/share/plasma/plasmoids/com.villepekkaa.spotprice

# Restart Plasma (testing changes)
kquitapp6 plasmashell && kstart plasmashell
# or
plasmashell --replace

# Check QML syntax
qml6 -typeinfo contents/ui/main.qml
```

## Coding Standards

- Use 4 spaces for indentation
- Comment complex QML bindings
- Use descriptive property names
- Follow Qt naming conventions (camelCase)

## Color Scheme

- Green: `#4CAF50` (price < 10 c/kWh)
- Yellow: `#FFC107` (price 10-20 c/kWh)
- Red: `#F44336` (price > 20 c/kWh)

## Testing Checklist

- [ ] Widget installs without errors
- [ ] Compact view shows current price
- [ ] Colors update correctly based on price
- [ ] Full view shows bar chart
- [ ] Day switching works
- [ ] Tomorrow prices show after 14:15
- [ ] Price margin and transfer fee affect displayed prices
- [ ] Caching works (no excessive API calls)
- [ ] Offline mode handles gracefully

## Common Issues

1. **Widget not appearing**: Check metadata.json syntax
2. **API errors**: Verify spot-hinta.fi is accessible
3. **Layout issues**: Check QML anchors and layouts
4. **Colors not updating**: Check price threshold logic

## Resources

- [KDE Plasma Widget Tutorial](https://develop.kde.org/docs/plasma/widget/)
- [QML Documentation](https://doc.qt.io/qt-6/qml-reference.html)
- [spot-hinta.fi API](https://spot-hinta.fi)
- [Plasma Framework API](https://api.kde.org/plasma-framework/html/)

## Git Workflow

1. Create feature branch
2. Make changes
3. Test locally
4. Commit with descriptive message (in **English**)
5. Push to GitHub
6. Create PR if needed

**Note**: All commit messages must be in English, even when communicating in Finnish. This ensures consistency in the git history and makes the project accessible to international contributors.

## Questions?

Contact: villepekkaa (GitHub)
